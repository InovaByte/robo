<html><head><base href="https://www.binance.com/"><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Bot de Trading Binance Futures - Estrat√©gia de Seguimento de Tend√™ncia</title><style>
body {
  font-size: 16px;
  padding: 1rem;
  font-family: Arial, sans-serif;
  background-color: #f0f2f5;
  margin: 0;
  color: #333;
}
.container {
  max-width: 100%;
  margin: 0 auto;
  background-color: #fff;
  border-radius: 8px;
  padding: 1rem;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 {
  color: #f0b90b;
  text-align: center;
  font-size: 1.5rem;
}
.controls {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
}
button {
  background-color: #f0b90b;
  border: none;
  color: white;
  padding: 0.5rem 1rem;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 1rem;
  margin: 4px 2px;
  cursor: pointer;
  border-radius: 4px;
}
.stats {
  display: flex;
  justify-content: space-between;
  background-color: #f8f9fa;
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 20px;
}
.stat {
  text-align: center;
}
.stat-value {
  font-size: 1.2rem;
  font-weight: bold;
  color: #f0b90b;
}
#log {
  margin-top: 20px;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 10px;
  font-family: monospace;
}
#signals {
  margin-top: 20px;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 4px;
  max-height: 200px;
  overflow-y: auto;
}
.signal {
  margin-bottom: 10px;
  padding: 10px;
  border-radius: 4px;
}
.signal.buy {
  background-color: #d4edda;
  color: #155724;
}
.signal.sell {
  background-color: #f8d7da;
  color: #721c24;
}
#tradingview-widget-container {
  position: relative;
  height: 60vh !important;
  margin-bottom: 20px;
}
#tradingview-widget-container > div {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}
#symbolSelector {
  width: 100%;
  padding: 10px;
  margin-bottom: 20px;
  font-size: 16px;
}
@media (min-width: 768px) {
  .container {
    max-width: 1200px;
    padding: 2rem;
  }
  
  h1 {
    font-size: 2rem;
  }
  
  .controls {
    flex-direction: row;
  }
  
  button {
    width: auto;
  }
  
  .stats {
    flex-direction: row;
  }
  
  .stat {
    margin-bottom: 0;
  }
  
  #tradingview-widget-container {
    height: 400px !important;
  }
}
@media (min-width: 1024px) {
  .container {
    padding: 2.5rem;
  }
  
  h1 {
    font-size: 2.5rem;
  }
  
  #tradingview-widget-container {
    height: 500px !important;
  }
}
body.dark-mode {
  background-color: #1a1a1a;
  color: #ffffff;
}
body.dark-mode .container {
  background-color: #2a2a2a;
}
body.dark-mode button {
  background-color: #3a3a3a;
  color: #ffffff;
}
body.dark-mode .stats {
  background-color: #3a3a3a;
}
body.dark-mode .stat-value {
  color: #f0b90b;
}
body.dark-mode #log,
body.dark-mode #signals {
  border-color: #4a4a4a;
}
body.dark-mode .signal.buy {
  background-color: #1e3a2b;
  color: #4caf50;
}
body.dark-mode .signal.sell {
  background-color: #3a1e1e;
  color: #f44336;
}
footer {
  margin-top: 20px;
  padding: 10px;
  background-color: #f0f2f5;
  text-align: center;
  font-size: 0.9rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
body.dark-mode footer {
  background-color: #2a2a2a;
  color: #ffffff;
}
.language-toggle {
  background-color: transparent;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: 5px 10px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background-color 0.3s;
}
.language-toggle:hover {
  background-color: #e0e0e0;
}
body.dark-mode .language-toggle {
  border-color: #555;
  color: #ffffff;
}
body.dark-mode .language-toggle:hover {
  background-color: #3a3a3a;
}
</style>
</head>
<body>
  <div class="container">
    <h1>Bot de Trading Binance Futures - Estrat√©gia de Seguimento de Tend√™ncia</h1>
    <select id="symbolSelector"></select>
    <div class="controls">
      <button id="startBtn">Iniciar Bot</button>
      <button id="stopBtn">Parar Bot</button>
      <button id="themeToggleBtn">Toggle Dark Mode</button>
    </div>
    <div id="tradingview-widget-container"></div>
    <div class="stats">
      <div class="stat">
        <div>Sinais Gerados</div>
        <div id="signalsCount" class="stat-value">0</div>
      </div>
      <div class="stat">
        <div>√öltimo Pre√ßo</div>
        <div id="lastPrice" class="stat-value">0 USDT</div>
      </div>
      <div class="stat">
        <div>Posi√ß√µes Abertas</div>
        <div id="openPositions" class="stat-value">0</div>
      </div>
    </div>
    <div id="signals"></div>
    <div id="log"></div>
  </div>
  <footer>
    <p>&copy; 2023 Jean Vieira. All rights reserved.</p>
    <button id="languageToggle" class="language-toggle">üåê PT</button>
  </footer>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
let symbol = 'BTCUSDT';
const interval = '15m';
let leverage = 20;
let positions = [];
let lastSignalTime = 0;
const signalCooldown = 15 * 60 * 1000; // 15 minutes in milliseconds

let isRunning = false;
let ws;
let signalsCount = 0;
let prices = [];
let volumes = [];
let ema50 = [];
let ema200 = [];
let rsiValues = [];
let widget;
let reconnectAttempts = 0;
const maxReconnectAttempts = 5;
const baseReconnectDelay = 1000;

// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAxDf9rZvv9qi-uooo9RXqTJojldocF1Vo",
  authDomain: "bot-trading-99f76.firebaseapp.com",
  projectId: "bot-trading-99f76",
  storageBucket: "bot-trading-99f76.appspot.com",
  messagingSenderId: "820777140022",
  appId: "1:820777140022:web:85d5e9114bb8e4d4c93d97",
  measurementId: "G-XS0JKX9TR7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function logMessage(message) {
  const logDiv = document.getElementById('log');
  if (logDiv) {
    const logEntry = document.createElement('div');
    logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
    logDiv.appendChild(logEntry);
    logDiv.scrollTop = logDiv.scrollHeight;
  } else {
    console.error('Log div not found');
  }
}

function saveDataToFirebase() {
  db.collection("tradingData").doc("currentState").set({
    prices: prices,
    volumes: volumes,
    ema50: ema50,
    ema200: ema200,
    rsiValues: rsiValues,
    positions: positions,
    signalsCount: signalsCount,
    lastSignalTime: lastSignalTime
  })
  .then(() => logMessage("Data saved to Firebase"))
  .catch((error) => logMessage("Error saving data: " + error));
}

function loadDataFromFirebase() {
  db.collection("tradingData").doc("currentState").get()
    .then((doc) => {
      if (doc.exists) {
        const data = doc.data();
        prices = data.prices;
        volumes = data.volumes;
        ema50 = data.ema50;
        ema200 = data.ema200;
        rsiValues = data.rsiValues;
        positions = data.positions;
        signalsCount = data.signalsCount;
        lastSignalTime = data.lastSignalTime;
        
        // Update UI with loaded data
        document.getElementById('signalsCount').textContent = signalsCount;
        document.getElementById('lastPrice').textContent = `${prices[prices.length - 1]} USDT`;
        document.getElementById('openPositions').textContent = positions.length;
        
        logMessage("Data loaded from Firebase");
      } else {
        logMessage("No data found in Firebase");
      }
    })
    .catch((error) => {
      if (error.code === 'unavailable') {
        logMessage("Failed to load data: You are offline. Please check your internet connection.");
      } else {
        logMessage("Error loading data: " + error);
      }
    });
}

document.addEventListener('DOMContentLoaded', loadDataFromFirebase);

async function fetchBinanceSymbols() {
  try {
    const response = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const data = await response.json();
    return data.symbols.map(symbol => symbol.symbol);
  } catch (error) {
    console.error('Error fetching Binance symbols:', error);
    logMessage(`Erro ao buscar s√≠mbolos da Binance: ${error.message}`);
    return [];
  }
}

function populateSymbolSelector(symbols) {
  const selector = document.getElementById('symbolSelector');
  selector.innerHTML = '';
  symbols.forEach(symbol => {
    const option = document.createElement('option');
    option.value = symbol;
    option.textContent = symbol;
    selector.appendChild(option);
  });
  selector.value = 'BTCUSDT'; // Set default value
}

function toggleTheme() {
  const body = document.body;
  const isDarkMode = body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', isDarkMode);
  updateTradingViewTheme(isDarkMode);
}

function updateTradingViewTheme(isDarkMode) {
  if (widget) {
    widget.options.theme = isDarkMode ? 'dark' : 'light';
    widget.reload();
  }
}

function initTradingViewWidget(initialSymbol) {
  if (widget) {
    widget.remove();
  }
  
  const isDarkMode = document.body.classList.contains('dark-mode');
  
  widget = new TradingView.widget({
    "width": "100%",
    "height": "100%",
    "symbol": "BINANCE:" + initialSymbol,
    "interval": "15",
    "timezone": "Etc/UTC",
    "theme": isDarkMode ? "dark" : "light",
    "style": "1",
    "locale": "br",
    "toolbar_bg": isDarkMode ? "#2a2a2a" : "#f1f3f6",
    "enable_publishing": false,
    "hide_side_toolbar": false,
    "allow_symbol_change": true,
    "studies": [
      "MASimple@tv-basicstudies",
      "MASimple@tv-basicstudies",
      "RSI@tv-basicstudies",
      "MACD@tv-basicstudies",
      "BB@tv-basicstudies"
    ],
    "container_id": "tradingview-widget-container",
    "studies_overrides": {
      "moving average.length": 9,
      "moving average.1.length": 21,
      "relative strength index.length": 14,
      "moving average convergence/divergence.fast length": 12,
      "moving average convergence/divergence.slow length": 26,
      "moving average convergence/divergence.signal smoothing": 9,
      "bollinger bands.length": 20,
      "bollinger bands.stddev": 2
    },
    "onSymbolChange": (symbol) => {
      updateSymbol(symbol.split(':')[1]);
    },
    "onChartReady": () => {
      logMessage('TradingView widget is ready');
    }
  });
}

function updateSymbol(newSymbol) {
  symbol = newSymbol;
  if (widget && widget.chart && typeof widget.chart.setSymbol === 'function') {
    widget.chart.setSymbol(`BINANCE:${newSymbol}`);
  } else {
    // If the widget or setSymbol method is not available, reinitialize the widget
    initTradingViewWidget(newSymbol);
  }
  resetBot();
  if (isRunning) {
    runBot();
  }
}

function runBot() {
  if (ws) {
    ws.close();
  }

  ws = new WebSocket(`wss://fstream.binance.com/ws/${symbol.toLowerCase()}@kline_${interval}`);

  ws.onopen = () => {
    logMessage(`WebSocket connection opened for ${symbol}`);
    reconnectAttempts = 0;
  };

  ws.onmessage = normalWebSocketHandler;

  ws.onclose = (event) => {
    logMessage(`WebSocket connection closed. Code: ${event.code}, Reason: ${event.reason}`);
    if (isRunning) {
      reconnect();
    }
  };

  ws.onerror = (error) => {
    logMessage(`WebSocket error: ${error.message}`);
  };
}

function reconnect() {
  if (reconnectAttempts < maxReconnectAttempts) {
    const delay = baseReconnectDelay * Math.pow(2, reconnectAttempts);
    logMessage(`Attempting to reconnect in ${delay / 1000} seconds...`);
    setTimeout(() => {
      reconnectAttempts++;
      runBot();
    }, delay);
  } else {
    logMessage('Max reconnection attempts reached. Please restart the bot manually.');
    isRunning = false;
  }
}

function resetBot() {
  if (ws) {
    ws.close();
  }
  prices = [];
  volumes = [];
  ema50 = [];
  ema200 = [];
  rsiValues = [];
  positions = [];
  signalsCount = 0;
  lastSignalTime = 0;
  document.getElementById('signalsCount').textContent = '0';
  document.getElementById('lastPrice').textContent = '0 USDT';
  document.getElementById('openPositions').textContent = '0';
  document.getElementById('signals').innerHTML = '';
  document.getElementById('log').innerHTML = '';
}

function calculateEMA(prices, period) {
  const k = 2 / (period + 1);
  let ema = prices[0];
  for (let i = 1; i < prices.length; i++) {
    ema = (prices[i] * k) + (ema * (1 - k));
  }
  return ema;
}

function calculateRSI(prices, period = 14) {
  if (prices.length < period + 1) {
    return [];
  }

  let gains = 0;
  let losses = 0;

  for (let i = 1; i <= period; i++) {
    const difference = prices[i] - prices[i - 1];
    if (difference >= 0) {
      gains += difference;
    } else {
      losses -= difference;
    }
  }

  let avgGain = gains / period;
  let avgLoss = losses / period;
  let rs = avgGain / avgLoss;
  let rsi = 100 - (100 / (1 + rs));
  let rsiValues = [rsi];

  for (let i = period + 1; i < prices.length; i++) {
    const difference = prices[i] - prices[i - 1];
    let currentGain = 0;
    let currentLoss = 0;

    if (difference >= 0) {
      currentGain = difference;
    } else {
      currentLoss = -difference;
    }

    avgGain = ((avgGain * (period - 1)) + currentGain) / period;
    avgLoss = ((avgLoss * (period - 1)) + currentLoss) / period;

    rs = avgGain / avgLoss;
    rsi = 100 - (100 / (1 + rs));
    rsiValues.push(rsi);
  }

  return rsiValues;
}

function generateSignal() {
  if (prices.length < 200 || ema50.length === 0 || ema200.length === 0 || rsiValues.length === 0) {
    return null;
  }

  const currentPrice = prices[prices.length - 1];
  const currentEMA50 = ema50[ema50.length - 1];
  const currentEMA200 = ema200[ema200.length - 1];
  const currentRSI = rsiValues[rsiValues.length - 1];

  const currentTime = Date.now();
  if (currentTime - lastSignalTime < signalCooldown) {
    return null;
  }

  if (currentEMA50 > currentEMA200 && currentPrice > currentEMA50 && currentRSI < 70) {
    lastSignalTime = currentTime;
    return 'buy';
  } else if (currentEMA50 < currentEMA200 && currentPrice < currentEMA50 && currentRSI > 30) {
    lastSignalTime = currentTime;
    return 'sell';
  }

  return null;
}

function displaySignal(signal, price) {
  const signalsDiv = document.getElementById('signals');
  const signalDiv = document.createElement('div');
  signalDiv.classList.add('signal', signal);
  signalDiv.textContent = `${signal.toUpperCase()} signal at ${price.toFixed(2)} USDT`;
  signalsDiv.prepend(signalDiv);

  if (signalsDiv.childElementCount > 10) {
    signalsDiv.removeChild(signalsDiv.lastChild);
  }

  signalsCount++;
  document.getElementById('signalsCount').textContent = signalsCount;
}

function openPosition(signal, price) {
  const position = {
    type: signal,
    entryPrice: price,
    quantity: 1, // You may want to calculate this based on available balance and risk management
  };
  positions.push(position);
  logMessage(`Opened ${signal} position at ${price.toFixed(2)} USDT`);
}

function updatePositions(currentPrice) {
  positions = positions.filter(position => {
    const pnl = position.type === 'buy' ? 
      (currentPrice - position.entryPrice) / position.entryPrice : 
      (position.entryPrice - currentPrice) / position.entryPrice;

    if (pnl >= 0.02 || pnl <= -0.01) { // 2% take profit or 1% stop loss
      logMessage(`Closed ${position.type} position. Entry: ${position.entryPrice.toFixed(2)}, Exit: ${currentPrice.toFixed(2)}, PNL: ${(pnl * 100).toFixed(2)}%`);
      return false;
    }
    return true;
  });
}

document.addEventListener('DOMContentLoaded', async function() {
  try {
    const symbols = await fetchBinanceSymbols();
    populateSymbolSelector(symbols);

    document.getElementById('startBtn').addEventListener('click', () => {
      if (!isRunning) {
        isRunning = true;
        logMessage('Iniciando bot...');
        runBot();
      }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      if (isRunning) {
        isRunning = false;
        if (ws) ws.close();
        logMessage('Parando bot...');
      }
    });

    document.getElementById('symbolSelector').addEventListener('change', (event) => {
      const newSymbol = event.target.value;
      updateSymbol(newSymbol);
    });

    document.getElementById('themeToggleBtn').addEventListener('click', toggleTheme);

    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
      document.body.classList.add('dark-mode');
    }

    initTradingViewWidget(symbol);
    
    const translations = {
      'pt': {
        'start': 'Iniciar Bot',
        'stop': 'Parar Bot',
        'darkMode': 'Alternar Modo Escuro',
        'signalsGenerated': 'Sinais Gerados',
        'lastPrice': '√öltimo Pre√ßo',
        'openPositions': 'Posi√ß√µes Abertas',
        'copyright': '¬© 2023 Jean Vieira. Todos os direitos reservados.'
      },
      'en': {
        'start': 'Start Bot',
        'stop': 'Stop Bot',
        'darkMode': 'Toggle Dark Mode',
        'signalsGenerated': 'Signals Generated',
        'lastPrice': 'Last Price',
        'openPositions': 'Open Positions',
        'copyright': '¬© 2023 Jean Vieira. All rights reserved.'
      },
      'es': {
        'start': 'Iniciar Bot',
        'stop': 'Detener Bot',
        'darkMode': 'Alternar Modo Oscuro',
        'signalsGenerated': 'Se√±ales Generadas',
        'lastPrice': '√öltimo Precio',
        'openPositions': 'Posiciones Abiertas',
        'copyright': '¬© 2023 Jean Vieira. Todos los derechos reservados.'
      }
    };

    let currentLanguage = 'pt';

    function changeLanguage(lang) {
      currentLanguage = lang;
      document.getElementById('startBtn').textContent = translations[lang]['start'];
      document.getElementById('stopBtn').textContent = translations[lang]['stop'];
      document.getElementById('themeToggleBtn').textContent = translations[lang]['darkMode'];
      document.querySelector('.stat:nth-child(1) > div:first-child').textContent = translations[lang]['signalsGenerated'];
      document.querySelector('.stat:nth-child(2) > div:first-child').textContent = translations[lang]['lastPrice'];
      document.querySelector('.stat:nth-child(3) > div:first-child').textContent = translations[lang]['openPositions'];
      document.querySelector('footer p').textContent = translations[lang]['copyright'];

      const languageToggle = document.getElementById('languageToggle');
      languageToggle.textContent = `üåê ${lang.toUpperCase()}`;
    }

    document.getElementById('languageToggle').addEventListener('click', () => {
      const languages = ['pt', 'en', 'es'];
      const currentIndex = languages.indexOf(currentLanguage);
      const nextLanguage = languages[(currentIndex + 1) % languages.length];
      changeLanguage(nextLanguage);
    });

    changeLanguage('pt'); // Set initial language
  } catch (error) {
    console.error('Error during initialization:', error);
    logMessage(`Erro durante a inicializa√ß√£o: ${error.message}`);
  }
});

function normalWebSocketHandler(event) {
  const data = JSON.parse(event.data);
  if (data.k) {
    const candle = data.k;
    const closePrice = parseFloat(candle.c);
    
    prices.push(closePrice);
    volumes.push(parseFloat(candle.v));
    
    if (prices.length > 200) {
      prices.shift();
      volumes.shift();
    }
    
    ema50 = calculateEMA(prices, 50);
    ema200 = calculateEMA(prices, 200);
    rsiValues = calculateRSI(prices);
    
    document.getElementById('lastPrice').textContent = `${closePrice.toFixed(2)} USDT`;
    
    const signal = generateSignal();
    if (signal) {
      displaySignal(signal, closePrice);
      openPosition(signal, closePrice);
    }
    
    updatePositions(closePrice);
    document.getElementById('openPositions').textContent = positions.length;
    saveDataToFirebase();
  }
}
</script>
</body></html>
