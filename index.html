<html><head><base href=".">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaskFlow - Gerenciador de Produtividade</title>

<style>
:root {
  --primary: #4A90E2;
  --secondary: #67B26F;
  --text: #2C3E50;
  --light: #F5F7FA;
  --shadow: rgba(0,0,0,0.1);
  
  /* Light theme (default) */
  --bg: #F5F7FA;
  --bg-card: white;
  --border: #E0E6ED;
  
  /* Dark theme variables */
  --dark-bg: #1a1a1a;
  --dark-bg-card: #2d2d2d;
  --dark-text: #e0e0e0;
  --dark-border: #404040;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', system-ui, sans-serif;
}

body {
  background: linear-gradient(135deg, var(--light), #E6E9F0);
  color: var(--text);
  min-height: 100vh;
}

body.dark-theme {
  background: var(--dark-bg);
  color: var(--dark-text);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.logo {
  font-size: 1.8rem;
  font-weight: bold;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.theme-toggle {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.theme-toggle:hover {
  background: rgba(128,128,128,0.2);
}

.main-content {
  display: grid;
  grid-template-columns: 300px 1fr;
  gap: 2rem;
}

.sidebar {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 4px 6px var(--shadow);
}

.sidebar.dark-theme {
  background: var(--dark-bg-card);
  color: var(--dark-text);
}

.tasks-container {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 4px 6px var(--shadow);
}

.tasks-container.dark-theme {
  background: var(--dark-bg-card);
  color: var(--dark-text);
}

.add-task {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.input {
  padding: 0.8rem;
  border: 2px solid #E0E6ED;
  border-radius: 6px;
  flex: 1;
  font-size: 1rem;
}

.input.dark-theme {
  background: var(--dark-bg-card);
  border-color: var(--dark-border);
  color: var(--dark-text);
}

.btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 6px;
  background: var(--primary);
  color: white;
  cursor: pointer;
  transition: transform 0.2s;
}

.btn:hover {
  transform: translateY(-2px);
}

.task-list {
  list-style: none;
}

.task-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #E0E6ED;
  animation: slideIn 0.3s ease-out;
  transition: all 0.3s ease;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  border: 1px solid #eee;
}

.task-item.dark-theme {
  border-color: var(--dark-border);
}

.task-item:hover {
  transform: translateX(5px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.task-checkbox {
  margin-right: 1rem;
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.task-content {
  flex: 1;
  padding: 0.5rem;
}

.task-text {
  flex: 1;
}

.task-delete {
  color: #FF5252;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
}

.task-delete:hover {
  opacity: 1;
}

.task-meta {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  margin-top: 0.5rem;
  font-size: 0.8rem;
  color: inherit;
}

.task-category {
  background: var(--primary);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
}

.task-due-date {
  color: inherit;
  font-weight: 500;
}

.progress-container {
  margin-bottom: 2rem;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #E0E6ED;
  border-radius: 4px;
  overflow: hidden;
  margin-top: 0.5rem;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  transition: width 0.3s ease;
}

.dark-theme .progress-bar,
.dark-theme .goal-bar {
  background: var(--dark-border);
}

.goals-section {
  margin-top: 2rem;
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 4px 6px var(--shadow);
}

.goals-section.dark-theme {
  background: var(--dark-bg-card);
  color: var(--dark-text);
}

.goal-item {
  display: flex;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #E0E6ED;
  gap: 1rem;
}

.goal-progress {
  flex: 1;
}

.goal-bar {
  height: 6px;
  background: #E0E6ED;
  border-radius: 3px;
  overflow: hidden;
}

.goal-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--secondary), var(--primary));
  transition: width 0.3s ease;
}

.daily-goals {
  margin-bottom: 2rem;
  padding: 1rem;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 4px var(--shadow);
}

.daily-goals.dark-theme {
  background: var(--dark-bg-card);
  color: var(--dark-text);
}

.daily-goal-progress {
  margin: 1rem 0;
}

.daily-goal-text {
  display: block;
  text-align: center;
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: inherit;
}

.daily-goal-settings {
  margin-top: 1rem;
  font-size: 0.9rem;
}

#daily-goal-input {
  width: 60px;
  padding: 0.3rem;
  margin-left: 0.5rem;
  border: 1px solid #E0E6ED;
  border-radius: 4px;
}

.checklist {
  margin-top: 1rem;
  padding: 1rem;
  background: var(--light);
  border-radius: 8px;
}

.checklist.dark-theme {
  background: var(--dark-bg-card);
  border: 1px solid var(--dark-border);
}

.checklist-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0.5rem 0;
}

.daily-task-toggle {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
}

.priority-alta { 
  border-left: 4px solid #FF5252; 
  background: rgba(255,82,82,0.05);
}
.priority-media { 
  border-left: 4px solid #FFC107; 
  background: rgba(255,193,7,0.05);
}
.priority-baixa { 
  border-left: 4px solid #4CAF50; 
  background: rgba(76,175,80,0.05);
}

.subtasks {
  margin-left: 20px;
  margin-top: 8px;
  font-size: 0.9em;
}

.pomodoro-timer {
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  color: white;
  padding: 2rem;
  margin-top: 2rem;
  border-radius: 15px;
  text-align: center;
}

.timer-display {
  font-size: 3rem;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.timer-controls {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
}

.timer-controls .btn {
  background: rgba(255,255,255,0.2);
  border: 2px solid rgba(255,255,255,0.4);
  transition: all 0.3s ease;
}

.timer-controls .btn:hover {
  background: rgba(255,255,255,0.3);
}

.health-tips {
  margin-top: 1rem;
  padding: 1rem;
  background: linear-gradient(135deg, #67B26F, #4ca2cd);
  border-radius: 8px;
  color: white;
}

.health-tips h4 {
  margin-bottom: 0.5rem;
  font-size: 1rem;
}

.tip {
  margin: 0.5rem 0;
  font-size: 0.9rem;
}

.tip strong {
  font-weight: 600;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .main-content {
    grid-template-columns: 1fr;
  }
  
  .container {
    padding: 1rem;
  }
  
  .header {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }
  
  .sidebar {
    margin-bottom: 1rem;
  }
  
  .add-task {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
  }
  
  .task-item {
    margin: 0.75rem 0;
    padding: 1rem;
  }
  
  .task-meta {
    flex-wrap: wrap;
  }
  
  .timer-display {
    font-size: 2.5rem;
  }
  
  .task-content {
    padding: 0;
  }
  
  .task-checkbox {
    width: 24px;
    height: 24px;
  }
  
  .task-delete {
    padding: 0.5rem;
    font-size: 1.2rem;
  }
  
  .input {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
  }
  
  .logo {
    font-size: 1.5rem;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 0.5rem;
  }
  
  .task-text {
    font-size: 0.9rem;
  }
  
  .progress-container h3 {
    font-size: 1rem;
  }
  
  #stats {
    font-size: 0.9rem;
  }
}

@media (hover: none) {
  .btn, 
  .task-checkbox,
  .task-delete {
    -webkit-tap-highlight-color: transparent;
    min-height: 44px;
    min-width: 44px;
  }
  
  .task-item {
    min-height: 44px;
  }
}
</style>
<script type="module">
// Update Firebase module imports at top of file
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { 
  getFirestore, 
  collection,
  getDocs,
  doc,
  getDoc, 
  setDoc,
  updateDoc
} from 'https://www.gstatic.com/firebasejs/9.22.1/firestore.js';
import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js';

// Firebase configuration with the provided credentials
const firebaseConfig = {
  apiKey: "AIzaSyCe4i17JoLqQ1hiamUKD4cWMr1KRVZhQ18",
  authDomain: "taskflow-640db.firebaseapp.com",
  projectId: "taskflow-640db", 
  storageBucket: "taskflow-640db.firebasestorage.app",
  messagingSenderId: "746862378320",
  appId: "1:746862378320:web:c2e8195bc26c41d7bcc055",
  measurementId: "G-V9NVS7LRXR"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Make db available globally 
window.db = db;

class TaskManager {
  constructor() {
    this.tasks = [];
    this.dailyGoal = 5;
    this.lastReset = new Date().toDateString();
    this.checklist = {
      items: [
        { id: 'daily-1', text: 'Revisar tarefas pendentes', completed: false },
        { id: 'daily-2', text: 'Definir prioridades', completed: false },
        { id: 'daily-3', text: 'Atualizar progresso', completed: false }
      ]
    };
    this.theme = 'light';

    // Load from localStorage first while Firebase loads
    this.loadFromLocalStorage();
    this.initializeData();
  }

  loadFromLocalStorage() {
    try {
      const savedData = localStorage.getItem('taskflow-data');
      if (savedData) {
        const data = JSON.parse(savedData);
        this.tasks = data.tasks || [];
        this.dailyGoal = data.dailyGoal || 5;
        this.lastReset = data.lastReset || new Date().toDateString();
        this.checklist = data.checklist || this.checklist;
        this.theme = data.theme || 'light';
      }
    } catch (error) {
      console.error("Error loading from localStorage:", error);
    }
  }

  saveToLocalStorage() {
    try {
      const data = {
        tasks: this.tasks,
        dailyGoal: this.dailyGoal,
        lastReset: this.lastReset,
        checklist: this.checklist,
        theme: this.theme,
        lastUpdated: new Date().toISOString()
      };
      localStorage.setItem('taskflow-data', JSON.stringify(data));
    } catch (error) {
      console.error("Error saving to localStorage:", error);
    }
  }

  async saveToFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'tasks');
      await setDoc(docRef, {
        tasks: this.tasks,
        dailyGoal: this.dailyGoal,
        lastReset: this.lastReset,
        checklist: this.checklist,
        theme: this.theme,
        lastUpdated: new Date().toISOString()
      });
      console.log('Data successfully saved to Firebase');
    } catch (error) {
      console.error("Error saving to Firebase:", error);
      // Fallback to localStorage if Firebase fails
      this.saveToLocalStorage();
    }
  }

  async loadFromFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'tasks');
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        this.tasks = data.tasks || [];
        this.dailyGoal = data.dailyGoal || 5;
        this.lastReset = data.lastReset || new Date().toDateString();
        this.checklist = data.checklist || this.checklist;
        this.theme = data.theme || 'light';
        console.log('Data successfully loaded from Firebase');
      } else {
        console.log('No data found in Firebase, loading from localStorage');
        this.loadFromLocalStorage();
      }
    } catch (error) {
      console.error("Error loading from Firebase:", error);
      // Fallback to localStorage if Firebase fails
      this.loadFromLocalStorage();
    }
  }

  async initializeData() {
    await this.loadFromFirebase();
    this.checkDailyReset();
    this.setupEventListeners();
    this.render();
    this.updateStats();
    this.loadChecklist();
    this.updateDailyGoalProgress();
    this.setupDailyGoalInput();
    this.setupThemeToggle();
    this.applyTheme();
  }

  createHealthTip(taskText) {
    const exerciseKeywords = ['exercício', 'exercicio', 'treino', 'academia', 'correr', 'corrida', 'musculação', 'yoga', 'pilates', 'alongamento', 'caminhada'];
    
    const isExerciseTask = exerciseKeywords.some(keyword => 
      taskText.toLowerCase().includes(keyword)
    );

    if (!isExerciseTask) return null;

    const healthTips = {
      pre: [
        "Lembre-se de se hidratar antes do exercício",
        "Faça um aquecimento adequado antes de começar",
        "Alimente-se pelo menos 1 hora antes do treino",
        "Use roupas confortáveis e apropriadas",
        "Mantenha uma boa noite de sono para melhor desempenho"
      ],
      during: [
        "Mantenha uma respiração controlada durante o exercício",
        "Preste atenção na sua postura",
        "Não force além dos seus limites",
        "Hidrate-se durante a atividade",
        "Mantenha um ritmo constante"
      ],
      post: [
        "Faça alongamentos após o exercício",
        "Hidrate-se bem após a atividade",
        "Consuma proteína dentro de 30 minutos após o treino",
        "Descanse adequadamente entre os treinos",
        "Monitore sua recuperação"
      ]
    };

    return {
      pre: healthTips.pre[Math.floor(Math.random() * healthTips.pre.length)],
      during: healthTips.during[Math.floor(Math.random() * healthTips.during.length)],
      post: healthTips.post[Math.floor(Math.random() * healthTips.post.length)]
    };
  }

  addTask() {
    const input = document.getElementById('task-input');
    const text = input.value.trim();
    
    if (text) {
      const healthTips = this.createHealthTip(text);
      
      const task = {
        id: Date.now(),
        text,
        completed: false,
        created: new Date().toISOString(),
        isDaily: document.getElementById('daily-task-toggle').checked,
        category: document.getElementById('task-category').value,
        priority: document.getElementById('task-priority').value,
        subtasks: [],
        repeat: document.getElementById('task-repeat').value,
        dueDate: document.getElementById('task-due-date').value,
        healthTips: healthTips // Add health tips to task object
      };
      
      this.tasks.push(task);
      this.saveTasks();
      this.render();
      this.updateStats();
      this.updateDailyGoalProgress();
      
      input.value = '';
      
      // Show health tips if available
      if (healthTips) {
        this.showHealthTips(healthTips);
      }
    }
  }

  showHealthTips(tips) {
    const tipsHTML = `
      <div class="health-tips">
        <h4>Dicas Saudáveis para seu Exercício</h4>
        <div class="tip"><strong>Antes:</strong> ${tips.pre}</div>
        <div class="tip"><strong>Durante:</strong> ${tips.during}</div>
        <div class="tip"><strong>Depois:</strong> ${tips.post}</div>
      </div>
    `;
    
    const taskItem = document.querySelector('.task-item:last-child');
    taskItem.insertAdjacentHTML('beforeend', tipsHTML);
  }

  saveTasks() {
    this.saveToFirebase();
  }

  saveChecklist() {
    this.saveToFirebase();
  }

  checkDailyReset() {
    const today = new Date().toDateString();
    if (this.lastReset !== today) {
      this.tasks = this.tasks.filter(task => !task.isDaily);
      this.checklist.items.forEach(item => item.completed = false);
      this.lastReset = today;
      localStorage.setItem('lastReset', today);
      this.saveTasks();
      this.saveChecklist();
    }
  }

  setupEventListeners() {
    document.getElementById('add-task-btn').addEventListener('click', () => this.addTask());
    document.getElementById('task-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.addTask();
    });
    
    document.getElementById('notification-btn').addEventListener('click', () => this.requestNotificationPermission());
    
    document.querySelectorAll('.checklist-item input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => this.updateChecklist(e.target.id, e.target.checked));
    });
  }

  setupThemeToggle() {
    const toggleBtn = document.getElementById('theme-toggle');
    toggleBtn.addEventListener('click', () => {
      this.theme = this.theme === 'light' ? 'dark' : 'light';
      this.applyTheme();
      this.saveToFirebase(); // Save theme change
    });
  }

  applyTheme() {
    document.body.classList.toggle('dark-theme', this.theme === 'dark');
    
    if (this.theme === 'dark') {
      document.querySelectorAll('.input').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.sidebar').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.tasks-container').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.task-item').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.daily-goals').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.goals-section').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.checklist').forEach(el => el.classList.add('dark-theme'));
    } else {
      document.querySelectorAll('.input').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.sidebar').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.tasks-container').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.task-item').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.daily-goals').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.goals-section').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.checklist').forEach(el => el.classList.remove('dark-theme'));
    }
  
    const toggleBtn = document.getElementById('theme-toggle');
    toggleBtn.querySelector('svg').innerHTML = this.theme === 'dark' 
      ? '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z"></path>'
      : '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
  }

  toggleTask(id) {
    const task = this.tasks.find(t => t.id === id);
    if (task) {
      task.completed = !task.completed;
      this.saveTasks(); // Use Firebase instead of localStorage
      this.render();
      this.updateStats();
      this.updateDailyGoalProgress();
    }
  }

  deleteTask(id) {
    this.tasks = this.tasks.filter(t => t.id !== id);
    this.saveTasks(); // Use Firebase instead of localStorage
    this.render();
    this.updateStats();
    this.updateDailyGoalProgress();
  }

  updateChecklist(id, completed) {
    const item = this.checklist.items.find(item => item.id === id);
    if (item) {
      item.completed = completed;
      this.saveChecklist();
      this.updateGoalProgress();
    }
  }

  loadChecklist() {
    this.checklist.items.forEach(item => {
      const checkbox = document.getElementById(item.id);
      if (checkbox) {
        checkbox.checked = item.completed;
      }
    });
    this.updateGoalProgress();
  }

  updateGoalProgress() {
    const completed = this.checklist.items.filter(item => item.completed).length;
    const total = this.checklist.items.length;
    const progress = (completed / total) * 100;
    
    document.querySelector('.goal-fill').style.width = `${progress}%`;
    document.querySelector('.goal-item span:last-child').textContent = `${Math.round(progress)}%`;
  }

  updateDailyGoalProgress() {
    const completed = this.tasks.filter(t => t.completed && t.isDaily).length;
    const progress = (completed / this.dailyGoal) * 100;
    
    document.querySelector('.daily-goal-fill').style.width = `${Math.min(progress, 100)}%`;
    document.querySelector('.daily-goal-text').textContent = 
      `${completed} / ${this.dailyGoal} tarefas`;
  }

  setupDailyGoalInput() {
    const input = document.getElementById('daily-goal-input');
    input.value = this.dailyGoal;
    input.addEventListener('change', (e) => {
      this.dailyGoal = parseInt(e.target.value) || 5;
      this.saveTasks();
      this.updateDailyGoalProgress();
    });
  }

  render() {
    const list = document.getElementById('task-list');
    list.innerHTML = '';
    
    this.tasks.forEach(task => {
      const li = document.createElement('li');
      li.className = 'task-item';
      li.classList.add(`priority-${task.priority}`);
      if (this.theme === 'dark') {
        li.classList.add('dark-theme');
      }
      
      li.innerHTML = `
        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
        <div class="task-content">
          <span class="task-text" style="${task.completed ? 'text-decoration: line-through' : ''}">${task.text}</span>
          <span class="task-category">${task.category}</span>
          <span class="task-due-date">${task.dueDate}</span>
          <div class="task-meta">
            <span class="task-priority">${task.priority}</span>
          </div>
          ${task.subtasks.length > 0 ? `
            <ul class="subtasks">
              ${task.subtasks.map(subtask => `
                <li>
                  <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''}>
                  <span>${subtask.text}</span>
                </li>
              `).join('')}
            </ul>
          ` : ''}
          ${task.healthTips ? `
            <div class="health-tips">
              <h4>Dicas Saudáveis para seu Exercício</h4>
              <div class="tip"><strong>Antes:</strong> ${task.healthTips.pre}</div>
              <div class="tip"><strong>Durante:</strong> ${task.healthTips.during}</div>
              <div class="tip"><strong>Depois:</strong> ${task.healthTips.post}</div>
            </div>
          ` : ''}
          <button class="btn-add-subtask">+ Subtarefa</button>
        </div>
        <span class="task-delete">❌</span>
      `;
      
      li.querySelector('.task-checkbox').addEventListener('change', () => this.toggleTask(task.id));
      li.querySelector('.task-delete').addEventListener('click', () => this.deleteTask(task.id));
      li.querySelector('.btn-add-subtask').addEventListener('click', () => {
        const subtaskText = prompt('Digite a subtarefa:');
        if (subtaskText) {
          this.createSubtask(task.id, subtaskText);
        }
      });
      
      list.appendChild(li);
    });
  }
  
  createSubtask(taskId, subtaskText) {
    const task = this.tasks.find(t => t.id === taskId);
    if (task) {
      task.subtasks.push({
        id: Date.now(),
        text: subtaskText,
        completed: false
      });
      this.saveTasks();
      this.render();
    }
  }

  updateStats() {
    const completed = this.tasks.filter(t => t.completed).length;
    const total = this.tasks.length;
    const progress = total === 0 ? 0 : (completed / total) * 100;
    
    document.querySelector('.progress-fill').style.width = `${progress}%`;
    document.getElementById('stats').innerHTML = `
      <p>Tarefas Completadas: ${completed}</p>
      <p>Tarefas Pendentes: ${total - completed}</p>
    `;
  }

  async requestNotificationPermission() {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        alert('Notificações ativadas com sucesso!');
      } else {
        alert('Seu navegador não suporta notificações.');
      }
    } else {
      alert('Seu navegador não suporta notificações.');
    }
  }

  scheduleNotification(task) {
    if ('Notification' in window && Notification.permission === 'granted') {
      setTimeout(() => {
        if (!task.completed) {
          this.scheduleNotification('Lembrete de Tarefa', `Não esqueça: ${task.text}`);
        }
      }, 2 * 60 * 60 * 1000); 
    }
  }
}

class PomodoroTimer {
  constructor() {
    this.timeLeft = 25 * 60; // 25 minutes
    this.isBreak = false;
    this.isRunning = false;
    this.interval = null;
    this.lastTick = Date.now(); // Track last tick timestamp
    
    this.loadFromLocalStorage();
    this.initializeTimer();
  }

  loadFromLocalStorage() {
    try {
      const savedTimer = localStorage.getItem('taskflow-timer');
      if (savedTimer) {
        const data = JSON.parse(savedTimer);
        
        // Calculate elapsed time since last save
        const now = Date.now();
        const elapsed = Math.floor((now - data.lastTick) / 1000);
        
        if (data.isRunning) {
          this.timeLeft = Math.max(0, data.timeLeft - elapsed);
          this.isBreak = data.isBreak;
          this.isRunning = true;
          this.lastTick = now;
        } else {
          this.timeLeft = data.timeLeft;
          this.isBreak = data.isBreak;
          this.isRunning = false;
        }
      }
    } catch (error) {
      console.error("Error loading timer from localStorage:", error);
    }
  }

  saveToLocalStorage() {
    try {
      const data = {
        timeLeft: this.timeLeft,
        isBreak: this.isBreak,
        isRunning: this.isRunning,
        lastTick: Date.now(),
        lastUpdated: new Date().toISOString()
      };
      localStorage.setItem('taskflow-timer', JSON.stringify(data));
    } catch (error) {
      console.error("Error saving timer to localStorage:", error);
    }
  }

  async saveToFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'timer');
      await setDoc(docRef, {
        timeLeft: this.timeLeft,
        isBreak: this.isBreak,
        isRunning: this.isRunning,
        lastTick: Date.now(),
        lastUpdated: new Date().toISOString()
      });
    } catch (error) {
      console.error("Error saving timer to Firebase:", error);
      this.saveToLocalStorage(); // Fallback to localStorage
    }
  }

  async loadFromFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'timer');
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        
        // Calculate elapsed time since last save
        const now = Date.now();
        const elapsed = Math.floor((now - data.lastTick) / 1000);
        
        if (data.isRunning) {
          this.timeLeft = Math.max(0, data.timeLeft - elapsed);
          this.isBreak = data.isBreak;
          this.isRunning = true;
          this.lastTick = now;
        } else {
          this.timeLeft = data.timeLeft;
          this.isBreak = data.isBreak;
          this.isRunning = false;
        }
        
        this.updateDisplay();
      }
    } catch (error) {
      console.error("Error loading timer from Firebase:", error);
      this.loadFromLocalStorage(); // Fallback to localStorage
    }
  }

  async initializeTimer() {
    await this.loadFromFirebase();
    this.setupUI();
    this.updateDisplay();
    
    // Resume timer if it was running
    if (this.isRunning) {
      this.interval = setInterval(() => this.tick(), 1000);
      document.getElementById('start-timer').textContent = 'Pausar';
    }
  }

  setupUI() {
    // Create pomodoro timer section if it doesn't exist
    if (!document.querySelector('.pomodoro-timer')) {
      const timerHTML = `
        <div class="pomodoro-timer">
          <div class="timer-display">25:00</div>
          <div class="timer-controls">
            <button class="btn" id="start-timer">Iniciar</button>
            <button class="btn" id="reset-timer">Resetar</button>
          </div>
        </div>
      `;
      document.querySelector('.sidebar').insertAdjacentHTML('beforeend', timerHTML);
    }

    // Add event listeners for timer controls
    document.getElementById('start-timer').addEventListener('click', () => this.toggleTimer());
    document.getElementById('reset-timer').addEventListener('click', () => this.resetTimer());
  }

  toggleTimer() {
    if (this.isRunning) {
      clearInterval(this.interval);
      this.isRunning = false;
      document.getElementById('start-timer').textContent = 'Iniciar';
    } else {
      this.isRunning = true;
      this.lastTick = Date.now();
      document.getElementById('start-timer').textContent = 'Pausar';
      this.interval = setInterval(() => this.tick(), 1000);
    }
    this.saveToLocalStorage();
    this.saveToFirebase();
  }

  tick() {
    const now = Date.now();
    const elapsed = Math.floor((now - this.lastTick) / 1000);
    this.lastTick = now;
    
    this.timeLeft = Math.max(0, this.timeLeft - elapsed);
    
    if (this.timeLeft <= 0) {
      this.toggleBreak();
    }
    
    this.updateDisplay();
    this.saveToLocalStorage();
    this.saveToFirebase();
  }

  updateDisplay() {
    const minutes = Math.floor(this.timeLeft / 60);
    const seconds = this.timeLeft % 60;
    document.querySelector('.timer-display').textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  resetTimer() {
    clearInterval(this.interval);
    this.isRunning = false;
    this.isBreak = false;
    this.timeLeft = 25 * 60;
    this.updateDisplay();
    document.getElementById('start-timer').textContent = 'Iniciar';
    this.saveToFirebase(); // Save state on reset
  }

  toggleBreak() {
    this.isBreak = !this.isBreak;
    this.timeLeft = this.isBreak ? 5 * 60 : 25 * 60;
    this.saveToFirebase(); // Save state when break toggles
    this.scheduleNotification('Pomodoro', this.isBreak ? 'Hora da pausa!' : 'Hora de voltar ao trabalho!');
  }
}

const taskManager = new TaskManager();
const pomodoroTimer = new PomodoroTimer();
</script>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="logo">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
      TaskFlow
    </div>
    <button class="btn" id="notification-btn">Ativar Notificações</button>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
  </header>

  <main class="main-content">
    <aside class="sidebar">
      <div class="progress-container">
        <h3>Progresso Diário</h3>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      <div id="stats">
        <p>Tarefas Completadas: 0</p>
        <p>Tarefas Pendentes: 0</p>
      </div>
      <div class="daily-goals">
        <h3>Meta Diária</h3>
        <div class="daily-goal-progress">
          <div class="goal-bar">
            <div class="goal-fill daily-goal-fill" style="width: 0%"></div>
          </div>
          <span class="daily-goal-text">0 / 5 tarefas</span>
        </div>
        <div class="daily-goal-settings">
          <label>Meta de tarefas diárias:</label>
          <input type="number" id="daily-goal-input" min="1" max="20" value="5">
        </div>
      </div>
      <div class="goals-section">
        <h3>Metas</h3>
        <div class="goal-item">
          <div class="goal-progress">
            <span>Meta Semanal</span>
            <div class="goal-bar">
              <div class="goal-fill" style="width: 60%"></div>
            </div>
          </div>
          <span>60%</span>
        </div>
        
        <div class="checklist">
          <h4>Checklist Diário</h4>
          <div class="checklist-item">
            <input type="checkbox" id="daily-1">
            <label for="daily-1">Revisar tarefas pendentes</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="daily-2">
            <label for="daily-2">Definir prioridades</label>
          </div>
          <div class="checklist-item">
            <input type="checkbox" id="daily-3">
            <label for="daily-3">Atualizar progresso</label>
          </div>
        </div>
      </div>
    </aside>

    <section class="tasks-container">
      <div class="add-task">
        <input type="text" class="input" id="task-input" placeholder="Adicionar nova tarefa...">
        <select id="task-category" class="input">
          <option value="">Selecionar Categoria</option>
          <option value="Trabalho">Trabalho</option>
          <option value="Estudos">Estudos</option>
          <option value="Pessoal">Pessoal</option>
          <option value="Outros">Outros</option>
        </select>
        <select id="task-priority" class="input">
          <option value="baixa">Baixa Prioridade</option>
          <option value="media">Média Prioridade</option>
          <option value="alta">Alta Prioridade</option>
        </select>
        <select id="task-repeat" class="input">
          <option value="none">Não Repetir</option>
          <option value="daily">Diário</option>
          <option value="weekly">Semanal</option>
          <option value="monthly">Mensal</option>
        </select>
        <input type="date" id="task-due-date" class="input">
        <label class="daily-task-toggle">
          <input type="checkbox" id="daily-task-toggle"> Tarefa diária
        </label>
        <button class="btn" id="add-task-btn">Adicionar</button>
      </div>
      <ul class="task-list" id="task-list"></ul>
    </section>
  </main>
</div>

<script>
class TaskManager {
  constructor() {
    this.tasks = [];
    this.dailyGoal = 5;
    this.lastReset = new Date().toDateString();
    this.checklist = {
      items: [
        { id: 'daily-1', text: 'Revisar tarefas pendentes', completed: false },
        { id: 'daily-2', text: 'Definir prioridades', completed: false },
        { id: 'daily-3', text: 'Atualizar progresso', completed: false }
      ]
    };
    this.theme = 'light';

    // Load from localStorage first while Firebase loads
    this.loadFromLocalStorage();
    this.initializeData();
  }

  loadFromLocalStorage() {
    try {
      const savedData = localStorage.getItem('taskflow-data');
      if (savedData) {
        const data = JSON.parse(savedData);
        this.tasks = data.tasks || [];
        this.dailyGoal = data.dailyGoal || 5;
        this.lastReset = data.lastReset || new Date().toDateString();
        this.checklist = data.checklist || this.checklist;
        this.theme = data.theme || 'light';
      }
    } catch (error) {
      console.error("Error loading from localStorage:", error);
    }
  }

  saveToLocalStorage() {
    try {
      const data = {
        tasks: this.tasks,
        dailyGoal: this.dailyGoal,
        lastReset: this.lastReset,
        checklist: this.checklist,
        theme: this.theme,
        lastUpdated: new Date().toISOString()
      };
      localStorage.setItem('taskflow-data', JSON.stringify(data));
    } catch (error) {
      console.error("Error saving to localStorage:", error);
    }
  }

  async saveToFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'tasks');
      await setDoc(docRef, {
        tasks: this.tasks,
        dailyGoal: this.dailyGoal,
        lastReset: this.lastReset,
        checklist: this.checklist,
        theme: this.theme,
        lastUpdated: new Date().toISOString()
      });
      console.log('Data successfully saved to Firebase');
    } catch (error) {
      console.error("Error saving to Firebase:", error);
      // Fallback to localStorage if Firebase fails
      this.saveToLocalStorage();
    }
  }

  async loadFromFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'tasks');
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        this.tasks = data.tasks || [];
        this.dailyGoal = data.dailyGoal || 5;
        this.lastReset = data.lastReset || new Date().toDateString();
        this.checklist = data.checklist || this.checklist;
        this.theme = data.theme || 'light';
        console.log('Data successfully loaded from Firebase');
      } else {
        console.log('No data found in Firebase, loading from localStorage');
        this.loadFromLocalStorage();
      }
    } catch (error) {
      console.error("Error loading from Firebase:", error);
      // Fallback to localStorage if Firebase fails
      this.loadFromLocalStorage();
    }
  }

  async initializeData() {
    await this.loadFromFirebase();
    this.checkDailyReset();
    this.setupEventListeners();
    this.render();
    this.updateStats();
    this.loadChecklist();
    this.updateDailyGoalProgress();
    this.setupDailyGoalInput();
    this.setupThemeToggle();
    this.applyTheme();
  }

  createHealthTip(taskText) {
    const exerciseKeywords = ['exercício', 'exercicio', 'treino', 'academia', 'correr', 'corrida', 'musculação', 'yoga', 'pilates', 'alongamento', 'caminhada'];
    
    const isExerciseTask = exerciseKeywords.some(keyword => 
      taskText.toLowerCase().includes(keyword)
    );

    if (!isExerciseTask) return null;

    const healthTips = {
      pre: [
        "Lembre-se de se hidratar antes do exercício",
        "Faça um aquecimento adequado antes de começar",
        "Alimente-se pelo menos 1 hora antes do treino",
        "Use roupas confortáveis e apropriadas",
        "Mantenha uma boa noite de sono para melhor desempenho"
      ],
      during: [
        "Mantenha uma respiração controlada durante o exercício",
        "Preste atenção na sua postura",
        "Não force além dos seus limites",
        "Hidrate-se durante a atividade",
        "Mantenha um ritmo constante"
      ],
      post: [
        "Faça alongamentos após o exercício",
        "Hidrate-se bem após a atividade",
        "Consuma proteína dentro de 30 minutos após o treino",
        "Descanse adequadamente entre os treinos",
        "Monitore sua recuperação"
      ]
    };

    return {
      pre: healthTips.pre[Math.floor(Math.random() * healthTips.pre.length)],
      during: healthTips.during[Math.floor(Math.random() * healthTips.during.length)],
      post: healthTips.post[Math.floor(Math.random() * healthTips.post.length)]
    };
  }

  addTask() {
    const input = document.getElementById('task-input');
    const text = input.value.trim();
    
    if (text) {
      const healthTips = this.createHealthTip(text);
      
      const task = {
        id: Date.now(),
        text,
        completed: false,
        created: new Date().toISOString(),
        isDaily: document.getElementById('daily-task-toggle').checked,
        category: document.getElementById('task-category').value,
        priority: document.getElementById('task-priority').value,
        subtasks: [],
        repeat: document.getElementById('task-repeat').value,
        dueDate: document.getElementById('task-due-date').value,
        healthTips: healthTips // Add health tips to task object
      };
      
      this.tasks.push(task);
      this.saveTasks();
      this.render();
      this.updateStats();
      this.updateDailyGoalProgress();
      
      input.value = '';
      
      // Show health tips if available
      if (healthTips) {
        this.showHealthTips(healthTips);
      }
    }
  }

  showHealthTips(tips) {
    const tipsHTML = `
      <div class="health-tips">
        <h4>Dicas Saudáveis para seu Exercício</h4>
        <div class="tip"><strong>Antes:</strong> ${tips.pre}</div>
        <div class="tip"><strong>Durante:</strong> ${tips.during}</div>
        <div class="tip"><strong>Depois:</strong> ${tips.post}</div>
      </div>
    `;
    
    const taskItem = document.querySelector('.task-item:last-child');
    taskItem.insertAdjacentHTML('beforeend', tipsHTML);
  }

  saveTasks() {
    this.saveToFirebase();
  }

  saveChecklist() {
    this.saveToFirebase();
  }

  checkDailyReset() {
    const today = new Date().toDateString();
    if (this.lastReset !== today) {
      this.tasks = this.tasks.filter(task => !task.isDaily);
      this.checklist.items.forEach(item => item.completed = false);
      this.lastReset = today;
      localStorage.setItem('lastReset', today);
      this.saveTasks();
      this.saveChecklist();
    }
  }

  setupEventListeners() {
    document.getElementById('add-task-btn').addEventListener('click', () => this.addTask());
    document.getElementById('task-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.addTask();
    });
    
    document.getElementById('notification-btn').addEventListener('click', () => this.requestNotificationPermission());
    
    document.querySelectorAll('.checklist-item input').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => this.updateChecklist(e.target.id, e.target.checked));
    });
  }

  setupThemeToggle() {
    const toggleBtn = document.getElementById('theme-toggle');
    toggleBtn.addEventListener('click', () => {
      this.theme = this.theme === 'light' ? 'dark' : 'light';
      this.applyTheme();
      this.saveToFirebase(); // Save theme change
    });
  }

  applyTheme() {
    document.body.classList.toggle('dark-theme', this.theme === 'dark');
    
    if (this.theme === 'dark') {
      document.querySelectorAll('.input').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.sidebar').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.tasks-container').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.task-item').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.daily-goals').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.goals-section').forEach(el => el.classList.add('dark-theme'));
      document.querySelectorAll('.checklist').forEach(el => el.classList.add('dark-theme'));
    } else {
      document.querySelectorAll('.input').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.sidebar').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.tasks-container').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.task-item').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.daily-goals').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.goals-section').forEach(el => el.classList.remove('dark-theme'));
      document.querySelectorAll('.checklist').forEach(el => el.classList.remove('dark-theme'));
    }
  
    const toggleBtn = document.getElementById('theme-toggle');
    toggleBtn.querySelector('svg').innerHTML = this.theme === 'dark' 
      ? '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9z"></path>'
      : '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
  }

  toggleTask(id) {
    const task = this.tasks.find(t => t.id === id);
    if (task) {
      task.completed = !task.completed;
      this.saveTasks(); // Use Firebase instead of localStorage
      this.render();
      this.updateStats();
      this.updateDailyGoalProgress();
    }
  }

  deleteTask(id) {
    this.tasks = this.tasks.filter(t => t.id !== id);
    this.saveTasks(); // Use Firebase instead of localStorage
    this.render();
    this.updateStats();
    this.updateDailyGoalProgress();
  }

  updateChecklist(id, completed) {
    const item = this.checklist.items.find(item => item.id === id);
    if (item) {
      item.completed = completed;
      this.saveChecklist();
      this.updateGoalProgress();
    }
  }

  loadChecklist() {
    this.checklist.items.forEach(item => {
      const checkbox = document.getElementById(item.id);
      if (checkbox) {
        checkbox.checked = item.completed;
      }
    });
    this.updateGoalProgress();
  }

  updateGoalProgress() {
    const completed = this.checklist.items.filter(item => item.completed).length;
    const total = this.checklist.items.length;
    const progress = (completed / total) * 100;
    
    document.querySelector('.goal-fill').style.width = `${progress}%`;
    document.querySelector('.goal-item span:last-child').textContent = `${Math.round(progress)}%`;
  }

  updateDailyGoalProgress() {
    const completed = this.tasks.filter(t => t.completed && t.isDaily).length;
    const progress = (completed / this.dailyGoal) * 100;
    
    document.querySelector('.daily-goal-fill').style.width = `${Math.min(progress, 100)}%`;
    document.querySelector('.daily-goal-text').textContent = 
      `${completed} / ${this.dailyGoal} tarefas`;
  }

  setupDailyGoalInput() {
    const input = document.getElementById('daily-goal-input');
    input.value = this.dailyGoal;
    input.addEventListener('change', (e) => {
      this.dailyGoal = parseInt(e.target.value) || 5;
      this.saveTasks();
      this.updateDailyGoalProgress();
    });
  }

  render() {
    const list = document.getElementById('task-list');
    list.innerHTML = '';
    
    this.tasks.forEach(task => {
      const li = document.createElement('li');
      li.className = 'task-item';
      li.classList.add(`priority-${task.priority}`);
      if (this.theme === 'dark') {
        li.classList.add('dark-theme');
      }
      
      li.innerHTML = `
        <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
        <div class="task-content">
          <span class="task-text" style="${task.completed ? 'text-decoration: line-through' : ''}">${task.text}</span>
          <span class="task-category">${task.category}</span>
          <span class="task-due-date">${task.dueDate}</span>
          <div class="task-meta">
            <span class="task-priority">${task.priority}</span>
          </div>
          ${task.subtasks.length > 0 ? `
            <ul class="subtasks">
              ${task.subtasks.map(subtask => `
                <li>
                  <input type="checkbox" class="subtask-checkbox" ${subtask.completed ? 'checked' : ''}>
                  <span>${subtask.text}</span>
                </li>
              `).join('')}
            </ul>
          ` : ''}
          ${task.healthTips ? `
            <div class="health-tips">
              <h4>Dicas Saudáveis para seu Exercício</h4>
              <div class="tip"><strong>Antes:</strong> ${task.healthTips.pre}</div>
              <div class="tip"><strong>Durante:</strong> ${task.healthTips.during}</div>
              <div class="tip"><strong>Depois:</strong> ${task.healthTips.post}</div>
            </div>
          ` : ''}
          <button class="btn-add-subtask">+ Subtarefa</button>
        </div>
        <span class="task-delete">❌</span>
      `;
      
      li.querySelector('.task-checkbox').addEventListener('change', () => this.toggleTask(task.id));
      li.querySelector('.task-delete').addEventListener('click', () => this.deleteTask(task.id));
      li.querySelector('.btn-add-subtask').addEventListener('click', () => {
        const subtaskText = prompt('Digite a subtarefa:');
        if (subtaskText) {
          this.createSubtask(task.id, subtaskText);
        }
      });
      
      list.appendChild(li);
    });
  }
  
  createSubtask(taskId, subtaskText) {
    const task = this.tasks.find(t => t.id === taskId);
    if (task) {
      task.subtasks.push({
        id: Date.now(),
        text: subtaskText,
        completed: false
      });
      this.saveTasks();
      this.render();
    }
  }

  updateStats() {
    const completed = this.tasks.filter(t => t.completed).length;
    const total = this.tasks.length;
    const progress = total === 0 ? 0 : (completed / total) * 100;
    
    document.querySelector('.progress-fill').style.width = `${progress}%`;
    document.getElementById('stats').innerHTML = `
      <p>Tarefas Completadas: ${completed}</p>
      <p>Tarefas Pendentes: ${total - completed}</p>
    `;
  }

  async requestNotificationPermission() {
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        alert('Notificações ativadas com sucesso!');
      } else {
        alert('Seu navegador não suporta notificações.');
      }
    } else {
      alert('Seu navegador não suporta notificações.');
    }
  }

  scheduleNotification(task) {
    if ('Notification' in window && Notification.permission === 'granted') {
      setTimeout(() => {
        if (!task.completed) {
          this.scheduleNotification('Lembrete de Tarefa', `Não esqueça: ${task.text}`);
        }
      }, 2 * 60 * 60 * 1000); 
    }
  }
}

class PomodoroTimer {
  constructor() {
    this.timeLeft = 25 * 60; // 25 minutes
    this.isBreak = false;
    this.isRunning = false;
    this.interval = null;
    this.lastTick = Date.now(); // Track last tick timestamp
    
    this.loadFromLocalStorage();
    this.initializeTimer();
  }

  loadFromLocalStorage() {
    try {
      const savedTimer = localStorage.getItem('taskflow-timer');
      if (savedTimer) {
        const data = JSON.parse(savedTimer);
        
        // Calculate elapsed time since last save
        const now = Date.now();
        const elapsed = Math.floor((now - data.lastTick) / 1000);
        
        if (data.isRunning) {
          this.timeLeft = Math.max(0, data.timeLeft - elapsed);
          this.isBreak = data.isBreak;
          this.isRunning = true;
          this.lastTick = now;
        } else {
          this.timeLeft = data.timeLeft;
          this.isBreak = data.isBreak;
          this.isRunning = false;
        }
      }
    } catch (error) {
      console.error("Error loading timer from localStorage:", error);
    }
  }

  saveToLocalStorage() {
    try {
      const data = {
        timeLeft: this.timeLeft,
        isBreak: this.isBreak,
        isRunning: this.isRunning,
        lastTick: Date.now(),
        lastUpdated: new Date().toISOString()
      };
      localStorage.setItem('taskflow-timer', JSON.stringify(data));
    } catch (error) {
      console.error("Error saving timer to localStorage:", error);
    }
  }

  async saveToFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'timer');
      await setDoc(docRef, {
        timeLeft: this.timeLeft,
        isBreak: this.isBreak,
        isRunning: this.isRunning,
        lastTick: Date.now(),
        lastUpdated: new Date().toISOString()
      });
    } catch (error) {
      console.error("Error saving timer to Firebase:", error);
      this.saveToLocalStorage(); // Fallback to localStorage
    }
  }

  async loadFromFirebase() {
    try {
      const docRef = doc(window.db, 'userData', 'timer');
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const data = docSnap.data();
        
        // Calculate elapsed time since last save
        const now = Date.now();
        const elapsed = Math.floor((now - data.lastTick) / 1000);
        
        if (data.isRunning) {
          this.timeLeft = Math.max(0, data.timeLeft - elapsed);
          this.isBreak = data.isBreak;
          this.isRunning = true;
          this.lastTick = now;
        } else {
          this.timeLeft = data.timeLeft;
          this.isBreak = data.isBreak;
          this.isRunning = false;
        }
        
        this.updateDisplay();
      }
    } catch (error) {
      console.error("Error loading timer from Firebase:", error);
      this.loadFromLocalStorage(); // Fallback to localStorage
    }
  }

  async initializeTimer() {
    await this.loadFromFirebase();
    this.setupUI();
    this.updateDisplay();
    
    // Resume timer if it was running
    if (this.isRunning) {
      this.interval = setInterval(() => this.tick(), 1000);
      document.getElementById('start-timer').textContent = 'Pausar';
    }
  }

  setupUI() {
    // Create pomodoro timer section if it doesn't exist
    if (!document.querySelector('.pomodoro-timer')) {
      const timerHTML = `
        <div class="pomodoro-timer">
          <div class="timer-display">25:00</div>
          <div class="timer-controls">
            <button class="btn" id="start-timer">Iniciar</button>
            <button class="btn" id="reset-timer">Resetar</button>
          </div>
        </div>
      `;
      document.querySelector('.sidebar').insertAdjacentHTML('beforeend', timerHTML);
    }

    // Add event listeners for timer controls
    document.getElementById('start-timer').addEventListener('click', () => this.toggleTimer());
    document.getElementById('reset-timer').addEventListener('click', () => this.resetTimer());
  }

  toggleTimer() {
    if (this.isRunning) {
      clearInterval(this.interval);
      this.isRunning = false;
      document.getElementById('start-timer').textContent = 'Iniciar';
    } else {
      this.isRunning = true;
      this.lastTick = Date.now();
      document.getElementById('start-timer').textContent = 'Pausar';
      this.interval = setInterval(() => this.tick(), 1000);
    }
    this.saveToLocalStorage();
    this.saveToFirebase();
  }

  tick() {
    const now = Date.now();
    const elapsed = Math.floor((now - this.lastTick) / 1000);
    this.lastTick = now;
    
    this.timeLeft = Math.max(0, this.timeLeft - elapsed);
    
    if (this.timeLeft <= 0) {
      this.toggleBreak();
    }
    
    this.updateDisplay();
    this.saveToLocalStorage();
    this.saveToFirebase();
  }

  updateDisplay() {
    const minutes = Math.floor(this.timeLeft / 60);
    const seconds = this.timeLeft % 60;
    document.querySelector('.timer-display').textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  resetTimer() {
    clearInterval(this.interval);
    this.isRunning = false;
    this.isBreak = false;
    this.timeLeft = 25 * 60;
    this.updateDisplay();
    document.getElementById('start-timer').textContent = 'Iniciar';
    this.saveToFirebase(); // Save state on reset
  }

  toggleBreak() {
    this.isBreak = !this.isBreak;
    this.timeLeft = this.isBreak ? 5 * 60 : 25 * 60;
    this.saveToFirebase(); // Save state when break toggles
    this.scheduleNotification('Pomodoro', this.isBreak ? 'Hora da pausa!' : 'Hora de voltar ao trabalho!');
  }
}

const taskManager = new TaskManager();
const pomodoroTimer = new PomodoroTimer();
</script>
</body></html>
